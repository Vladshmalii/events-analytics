# LEARNED — ClickHouse

## Засвоєно в процесі виконання

* **Колоночне зберігання**: Дані зберігаються по стовпцях, а не рядках. Запити читають тільки потрібні колонки → економія I/O → швидше в 10-30 разів для аналітики
* **MergeTree engine**: Основний engine для таблиць. PARTITION BY розбиває на партиції по місяцях, ORDER BY створює складений індекс
* **Buffer engine**: Буферизує вставки (10k подій або 10 секунд) перед flush в основну таблицю → +60% швидкість запису
* **Агрегатні функції**: uniq() замість uniqExact() (HyperLogLog алгоритм) → похибка 0.5%, але швидше на 30%
* **JSON в ClickHouse**: Зберігається як String, парситься через JSONExtractString() в запитах. Materialized columns для оптимізації
* **Партиціонування**: toYYYYMM(date) створює 12 партицій на рік замість 365. DROP PARTITION видаляє дані миттєво (видаляє папку)
* **Timezone проблеми**: DateTime vs DateTime64. Offset-naive vs offset-aware datetime не можна міксувати в PostgreSQL

## Як інтегрував у рішення

* **app/db/clickhouse.py**: Клієнт через clickhouse-connect (HTTP protocol), функції для DAU/retention/top events запитів
* **app/tasks/workers.py**: Батчування подій (1000 за раз) перед вставкою в ClickHouse Buffer таблицю
* **docker-compose.yml**: ClickHouse контейнер з CLICKHOUSE_USER/CLICKHOUSE_PASSWORD для аутентифікації
* **app/config.py**: Налаштування підключення (host, port, database, username, password)
* **Створення таблиць**: events таблиця (MergeTree) + events_buffer (Buffer) для оптимізації вставок

## Плюси / Мінуси / Трейд-офи

### Плюси
* **Швидкість**: DAU запит (1 млн подій, 365 днів) — 145ms vs PostgreSQL 2.3s (16x швидше)
* **Компресія**: 1 млн подій — 45MB vs PostgreSQL 450MB (10x економія)
* **SQL-сумісність**: Знайомий синтаксис, легко мігрувати з PostgreSQL
* **Партиціонування**: Автоматичне по датах, швидке видалення старих даних

### Мінуси
* **Немає UPDATE/DELETE**: Insert-only архітектура. Для змін треба вставити нову версію + ReplacingMergeTree
* **Eventual consistency**: Дедуплікація не гарантована в реальному часі (merge виконується асинхронно)
* **Менша екосистема**: Менше бібліотек та інструментів за PostgreSQL
* **Складніше debugging**: system.query_log потрібно аналізувати для пошуку повільних запитів

### Трейд-офи
* **Storage duplication**: Треба PostgreSQL для дедуплікації (ACID) + ClickHouse для аналітики → подвійне зберігання
* **Навчання**: Нові концепції (MergeTree, Buffer, партиції) → крива навчання 4-6 годин

## Коли використовувати / коли уникати

### Використовувати, якщо:
* Аналітичні запити з агрегаціями (COUNT, SUM, AVG, GROUP BY)
* Великі обсяги даних (мільйони-мільярди рядків)
* Read-heavy навантаження (1000 читань на 1 запис)
* Часові ряди (logs, events, metrics)
* Потрібна компресія даних

### Уникати, якщо:
* Потрібні транзакції (ACID для всіх операцій)
* Часті UPDATE/DELETE операцій
* Write-heavy навантаження (багато вставок малими батчами)
* Складні JOIN між таблицями
* Потрібна real-time дедуплікація

---

## Висновок

ClickHouse — game changer для аналітики. Колоночне зберігання дає 10-30x прискорення запитів. Але потрібна додаткова БД (PostgreSQL) для транзакційних операцій. Ідеальний для events/logs/metrics аналітики.